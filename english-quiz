<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±ä¼šè©±ã‚¯ã‚¤ã‚º - æ—…è¡Œãƒ•ãƒ¬ãƒ¼ã‚ºãƒã‚¹ã‚¿ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .quiz-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }

        .quiz-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: #e0e0e0;
        }

        .quiz-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .quiz-counter {
            font-size: 1.2em;
            color: #666;
        }

        .quiz-score {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
        }

        .quiz-content {
            text-align: center;
            padding: 20px 0;
        }

        .question-text {
            font-size: 2em;
            color: #333;
            margin-bottom: 40px;
            line-height: 1.4;
            font-weight: 600;
        }

        .answer-options {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .answer-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 15px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .answer-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(5px);
        }

        .answer-btn.correct {
            background: #e8f5e9;
            border-color: #4caf50;
            animation: correctPulse 0.6s ease;
        }

        .answer-btn.incorrect {
            background: #ffebee;
            border-color: #f44336;
            animation: shake 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .voice-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 50px;
            background: #667eea;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .voice-btn:active {
            transform: translateY(0);
        }

        .voice-btn.listening {
            background: #f44336;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        .input-container {
            margin-bottom: 30px;
        }

        .text-input {
            width: 100%;
            padding: 20px;
            font-size: 1.3em;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .submit-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            background: #4caf50;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .feedback {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1em;
            animation: slideIn 0.5s ease;
        }

        .feedback.correct {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .feedback.incorrect {
            background: #ffebee;
            color: #c62828;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .results-title {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 30px;
        }

        .results-score {
            font-size: 4em;
            color: #4caf50;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .results-message {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 30px;
        }

        .results-details {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .restart-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            background: #667eea;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .start-screen {
            text-align: center;
            padding: 40px;
        }

        .start-screen h2 {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
        }

        .start-screen p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .start-btn {
            padding: 20px 50px;
            border: none;
            border-radius: 50px;
            background: #4caf50;
            color: white;
            font-size: 1.4em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
        }

        .hint-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: #ff9800;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .hint-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .hint-text {
            color: #ff9800;
            font-style: italic;
            margin-top: 15px;
            font-size: 1.1em;
        }

        .permission-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .permission-info h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .permission-info ol {
            margin-left: 20px;
            color: #856404;
        }

        .permission-info li {
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .mode-btn {
                font-size: 1em;
                padding: 12px 20px;
            }
            
            .question-text {
                font-size: 1.5em;
            }
            
            .quiz-container {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ è‹±ä¼šè©±ã‚¯ã‚¤ã‚º</h1>
            <p>æ—…è¡Œã§ä½¿ãˆã‚‹è‹±ä¼šè©±ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ã‚¯ã‚¤ã‚ºã§æ¥½ã—ãå­¦ç¿’ï¼</p>
            <div class="mode-selector" id="modeSelector">
                <button class="mode-btn active" onclick="selectMode('translate')">
                    ğŸ“ ç¿»è¨³ã‚¯ã‚¤ã‚º
                </button>
                <button class="mode-btn" onclick="selectMode('listening')">
                    ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¯ã‚¤ã‚º
                </button>
                <button class="mode-btn" onclick="selectMode('speaking')">
                    ğŸ¤ ç™ºéŸ³ã‚¯ã‚¤ã‚º
                </button>
                <button class="mode-btn" onclick="selectMode('dictation')">
                    âœï¸ ãƒ‡ã‚£ã‚¯ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
                </button>
            </div>
        </div>

        <div class="quiz-container" id="quizContainer">
            <div class="start-screen" id="startScreen">
                <h2>ğŸ“ ç¿»è¨³ã‚¯ã‚¤ã‚º</h2>
                <p>
                    æ—¥æœ¬èªã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¦‹ã¦ã€æ­£ã—ã„è‹±è¨³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>
                    å…¨20å•ã®ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼
                </p>
                <button class="start-btn" onclick="startQuiz()">
                    ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ ğŸš€
                </button>
                <br><br>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="voice-btn" onclick="testVoice()" style="font-size: 0.9em; padding: 10px 20px;">
                        ğŸ”Š éŸ³å£°ãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿
        const phrases = [
            { id: 1, japanese: "ã“ã‚“ã«ã¡ã¯", english: "Hello", category: "greeting", difficulty: 1 },
            { id: 2, japanese: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™", english: "Thank you", category: "greeting", difficulty: 1 },
            { id: 3, japanese: "ã™ã¿ã¾ã›ã‚“", english: "Excuse me", category: "greeting", difficulty: 1 },
            { id: 4, japanese: "ã“ã‚Œã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ", english: "How much is this?", category: "shopping", difficulty: 1 },
            { id: 5, japanese: "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ", english: "Do you accept credit cards?", category: "shopping", difficulty: 2 },
            { id: 6, japanese: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", english: "Where is the restroom?", category: "direction", difficulty: 1 },
            { id: 7, japanese: "é“ã«è¿·ã„ã¾ã—ãŸ", english: "I'm lost", category: "direction", difficulty: 2 },
            { id: 8, japanese: "è‹±èªã‚’è©±ã›ã¾ã™ã‹ï¼Ÿ", english: "Do you speak English?", category: "communication", difficulty: 1 },
            { id: 9, japanese: "ã‚‚ã†ä¸€åº¦è¨€ã£ã¦ãã ã•ã„", english: "Please say that again", category: "communication", difficulty: 2 },
            { id: 10, japanese: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ãŠé¡˜ã„ã—ã¾ã™", english: "I'd like to check in", category: "hotel", difficulty: 2 },
            { id: 11, japanese: "äºˆç´„ãŒã‚ã‚Šã¾ã™", english: "I have a reservation", category: "hotel", difficulty: 2 },
            { id: 12, japanese: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãã ã•ã„", english: "May I have the menu?", category: "restaurant", difficulty: 1 },
            { id: 13, japanese: "ãŠå‹§ã‚ã¯ä½•ã§ã™ã‹ï¼Ÿ", english: "What do you recommend?", category: "restaurant", difficulty: 2 },
            { id: 14, japanese: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™", english: "Check please", category: "restaurant", difficulty: 1 },
            { id: 15, japanese: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãŒã‚ã‚Šã¾ã™", english: "I have allergies", category: "restaurant", difficulty: 3 },
            { id: 16, japanese: "ã‚¿ã‚¯ã‚·ãƒ¼ã‚’å‘¼ã‚“ã§ãã ã•ã„", english: "Please call a taxi", category: "transportation", difficulty: 2 },
            { id: 17, japanese: "ç©ºæ¸¯ã¾ã§ãŠé¡˜ã„ã—ã¾ã™", english: "To the airport please", category: "transportation", difficulty: 2 },
            { id: 18, japanese: "ã„ã¤åˆ°ç€ã—ã¾ã™ã‹ï¼Ÿ", english: "When will we arrive?", category: "transportation", difficulty: 2 },
            { id: 19, japanese: "åŠ©ã‘ã¦ãã ã•ã„", english: "Help me please", category: "emergency", difficulty: 1 },
            { id: 20, japanese: "åŒ»è€…ã‚’å‘¼ã‚“ã§ãã ã•ã„", english: "Please call a doctor", category: "emergency", difficulty: 3 }
        ];

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let currentMode = 'translate';
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = [];
        let currentQuestion = null;
        let isAnswering = false;
        let recognition = null;
        let isSpeechAvailable = false;

        // åˆæœŸåŒ–å‡¦ç†
        window.addEventListener('DOMContentLoaded', function() {
            // éŸ³å£°åˆæˆAPIã®ãƒã‚§ãƒƒã‚¯
            if ('speechSynthesis' in window) {
                isSpeechAvailable = true;
                console.log('éŸ³å£°åˆæˆAPIåˆ©ç”¨å¯èƒ½');
                
                // éŸ³å£°ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
                if (speechSynthesis.getVoices().length === 0) {
                    speechSynthesis.addEventListener('voiceschanged', function() {
                        console.log('éŸ³å£°ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
                    });
                }
            } else {
                console.error('éŸ³å£°åˆæˆAPIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nChromeã€Edgeã€Safariç­‰ã®æœ€æ–°ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
            }
        });

        // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.error('éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return false;
                }
                
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                console.log('éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
                return true;
            } catch (error) {
                console.error('éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        function selectMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’æ›´æ–°
            const startScreen = document.getElementById('startScreen');
            const modeInfo = {
                translate: {
                    title: 'ğŸ“ ç¿»è¨³ã‚¯ã‚¤ã‚º',
                    desc: 'æ—¥æœ¬èªã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¦‹ã¦ã€æ­£ã—ã„è‹±è¨³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'
                },
                listening: {
                    title: 'ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¯ã‚¤ã‚º',
                    desc: 'è‹±èªã®éŸ³å£°ã‚’èã„ã¦ã€æ­£ã—ã„æ—¥æœ¬èªè¨³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'
                },
                speaking: {
                    title: 'ğŸ¤ ç™ºéŸ³ã‚¯ã‚¤ã‚º',
                    desc: 'æ—¥æœ¬èªã‚’è¦‹ã¦ã€è‹±èªã§ç™ºéŸ³ã—ã¦ãã ã•ã„ã€‚'
                },
                dictation: {
                    title: 'âœï¸ ãƒ‡ã‚£ã‚¯ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
                    desc: 'è‹±èªã®éŸ³å£°ã‚’èã„ã¦ã€æ­£ã—ãæ›¸ãå–ã£ã¦ãã ã•ã„ã€‚'
                }
            };
            
            startScreen.innerHTML = `
                <h2>${modeInfo[mode].title}</h2>
                <p>${modeInfo[mode].desc}<br>å…¨20å•ã®ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼</p>
                <button class="start-btn" onclick="startQuiz()">
                    ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ ğŸš€
                </button>
                <br><br>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="voice-btn" onclick="testVoice()" style="font-size: 0.9em; padding: 10px 20px;">
                        ğŸ”Š éŸ³å£°ãƒ†ã‚¹ãƒˆ
                    </button>
                    ${mode === 'speaking' ? `
                        <button class="voice-btn" onclick="testMicrophone()" style="font-size: 0.9em; padding: 10px 20px; background: #ff9800;">
                            ğŸ¤ ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆ
                        </button>
                    ` : ''}
                </div>
                ${mode === 'speaking' ? `
                    <p style="color: #666; font-size: 0.9em; margin-top: 20px;">
                        â€» ç™ºéŸ³ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹å‰ã«ã€ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆã§å‹•ä½œç¢ºèªã‚’ãŠå‹§ã‚ã—ã¾ã™
                    </p>
                ` : ''}
            `;
        }

        // ã‚¯ã‚¤ã‚ºé–‹å§‹
        async function startQuiz() {
            // ç™ºéŸ³ã‚¯ã‚¤ã‚ºã®å ´åˆã€äº‹å‰ã«ãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèª
            if (currentMode === 'speaking') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    console.log('ãƒã‚¤ã‚¯è¨±å¯ç¢ºèªæ¸ˆã¿');
                } catch (error) {
                    console.error('ãƒã‚¤ã‚¯è¨±å¯ã‚¨ãƒ©ãƒ¼:', error);
                    
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        const confirmStart = confirm(
                            'âš ï¸ ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™\n\n' +
                            'ç™ºéŸ³ã‚¯ã‚¤ã‚ºã§ã¯ãƒã‚¤ã‚¯ãŒå¿…è¦ã§ã™ã€‚\n' +
                            'ä»¥ä¸‹ã®æ‰‹é †ã§è¨±å¯ã—ã¦ãã ã•ã„ï¼š\n\n' +
                            '1. ã“ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹\n' +
                            '2. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ğŸ”’ã¾ãŸã¯ğŸ“·ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
                            '3. ã€Œãƒã‚¤ã‚¯ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n' +
                            '4. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿\n\n' +
                            'ãƒã‚¤ã‚¯ãªã—ã§ç¶šã‘ã¾ã™ã‹ï¼Ÿï¼ˆéŒ²éŸ³æ©Ÿèƒ½ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼‰'
                        );
                        if (!confirmStart) {
                            return;
                        }
                    } else {
                        const confirmStart = confirm(
                            'âš ï¸ ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“\n\n' +
                            'ã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\n' +
                            'ãƒã‚¤ã‚¯ãªã—ã§ç¶šã‘ã¾ã™ã‹ï¼Ÿï¼ˆéŒ²éŸ³æ©Ÿèƒ½ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼‰'
                        );
                        if (!confirmStart) {
                            return;
                        }
                    }
                }
            }
            
            currentQuestionIndex = 0;
            score = 0;
            questions = [...phrases].sort(() => Math.random() - 0.5);
            initSpeechRecognition();
            showQuestion();
        }

        // è³ªå•è¡¨ç¤º
        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }
            
            currentQuestion = questions[currentQuestionIndex];
            isAnswering = false;
            
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="quiz-progress">
                    <div class="quiz-progress-bar" style="width: ${(currentQuestionIndex / questions.length) * 100}%"></div>
                </div>
                <div class="quiz-header">
                    <div class="quiz-counter">å•é¡Œ ${currentQuestionIndex + 1} / ${questions.length}</div>
                    <div class="quiz-score">ã‚¹ã‚³ã‚¢: ${score}</div>
                </div>
                <div class="quiz-content" id="quizContent">
                    ${getQuestionContent()}
                </div>
            `;
            
            // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®åˆæœŸå‡¦ç†
            if (currentMode === 'listening') {
                // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦éŸ³å£°ã‚’å†ç”Ÿï¼ˆUIã®æç”»ã‚’å¾…ã¤ï¼‰
                setTimeout(() => {
                    console.log('ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¯ã‚¤ã‚º: éŸ³å£°ã‚’è‡ªå‹•å†ç”Ÿ');
                    playQuestionAudio();
                }, 1000);
            }
        }

        // è³ªå•ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
        function getQuestionContent() {
            switch (currentMode) {
                case 'translate':
                    return `
                        <div class="question-text">${currentQuestion.japanese}</div>
                        <div class="answer-options">
                            ${generateMultipleChoice('english').map((option, index) => `
                                <button class="answer-btn" onclick="checkAnswer('${option}', this)">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    `;
                
                case 'listening':
                    return `
                        <div class="voice-controls">
                            <button class="voice-btn" onclick="playQuestionAudio()">
                                ğŸ”Š ã‚‚ã†ä¸€åº¦èã
                            </button>
                        </div>
                        <div class="question-text">ã©ã†ã„ã†æ„å‘³ã§ã—ã‚‡ã†ã‹ï¼Ÿ</div>
                        <div class="answer-options">
                            ${generateMultipleChoice('japanese').map((option, index) => `
                                <button class="answer-btn" onclick="checkAnswer('${option}', this)">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    `;
                
                case 'speaking':
                    return `
                        <div class="question-text">${currentQuestion.japanese}</div>
                        <p style="color: #666; margin-bottom: 20px;">è‹±èªã§ç™ºéŸ³ã—ã¦ãã ã•ã„</p>
                        <div class="voice-controls">
                            <button class="voice-btn" id="recordBtn" onclick="startRecording()">
                                ğŸ¤ éŒ²éŸ³é–‹å§‹
                            </button>
                            <button class="voice-btn" onclick="playAnswer()">
                                ğŸ”Š ãŠæ‰‹æœ¬ã‚’èã
                            </button>
                        </div>
                        <div id="recognizedText" style="margin-top: 20px;"></div>
                        <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                            ğŸ’¡ ãƒ’ãƒ³ãƒˆ: åˆå›ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒã‚¤ã‚¯ä½¿ç”¨è¨±å¯ã‚’æ±‚ã‚ã¾ã™ã€‚ã€Œè¨±å¯ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    `;
                
                case 'dictation':
                    return `
                        <div class="voice-controls">
                            <button class="voice-btn" onclick="playQuestionAudio()">
                                ğŸ”Š ã‚‚ã†ä¸€åº¦èã
                            </button>
                        </div>
                        <div class="question-text">èã“ãˆãŸè‹±èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                        <div class="input-container">
                            <input type="text" class="text-input" id="dictationInput" 
                                   placeholder="è‹±èªã‚’å…¥åŠ›..." onkeypress="if(event.key==='Enter') checkDictation()">
                        </div>
                        <button class="submit-btn" onclick="checkDictation()">å›ç­”ã™ã‚‹</button>
                        <button class="hint-btn" onclick="showHint()">ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
                        <div id="hintText"></div>
                    `;
            }
        }

        // é¸æŠè‚¢ç”Ÿæˆ
        function generateMultipleChoice(type) {
            const correct = currentQuestion[type];
            const options = [correct];
            
            // ä»–ã®é¸æŠè‚¢ã‚’è¿½åŠ 
            const others = phrases
                .filter(p => p.id !== currentQuestion.id)
                .map(p => p[type])
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            
            options.push(...others);
            return options.sort(() => Math.random() - 0.5);
        }

        // éŸ³å£°å†ç”Ÿ
        function playQuestionAudio() {
            if (!isSpeechAvailable) {
                alert('éŸ³å£°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }
            
            try {
                // æ—¢å­˜ã®éŸ³å£°ã‚’åœæ­¢
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(currentQuestion.english);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                utterance.onerror = function(event) {
                    console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', event);
                    alert('éŸ³å£°å†ç”Ÿã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                };
                
                // å†ç”Ÿ
                window.speechSynthesis.speak(utterance);
                console.log('éŸ³å£°å†ç”Ÿ:', currentQuestion.english);
            } catch (error) {
                console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                alert('éŸ³å£°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
        }

        function playAnswer() {
            if (!isSpeechAvailable) {
                alert('éŸ³å£°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }
            
            try {
                // æ—¢å­˜ã®éŸ³å£°ã‚’åœæ­¢
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(currentQuestion.english);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                utterance.onerror = function(event) {
                    console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', event);
                };
                
                window.speechSynthesis.speak(utterance);
                console.log('ãŠæ‰‹æœ¬éŸ³å£°å†ç”Ÿ:', currentQuestion.english);
            } catch (error) {
                console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                alert('éŸ³å£°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
        }

        // å›ç­”ãƒã‚§ãƒƒã‚¯ï¼ˆé¸æŠå¼ï¼‰
        function checkAnswer(answer, button) {
            if (isAnswering) return;
            isAnswering = true;
            
            const correct = currentMode === 'listening' ? currentQuestion.japanese : currentQuestion.english;
            const isCorrect = answer === correct;
            
            button.classList.add(isCorrect ? 'correct' : 'incorrect');
            
            if (isCorrect) {
                score++;
                showFeedback(true, 'æ­£è§£ï¼ğŸ‰');
                // æ­£è§£ã®å ´åˆã€è‹±èªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’èª­ã¿ä¸Šã’ã‚‹
                if (isSpeechAvailable && currentMode === 'translate') {
                    setTimeout(() => {
                        try {
                            const utterance = new SpeechSynthesisUtterance(currentQuestion.english);
                            utterance.lang = 'en-US';
                            utterance.rate = 0.9;
                            window.speechSynthesis.speak(utterance);
                        } catch (error) {
                            console.error('æ­£è§£éŸ³å£°ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    }, 500);
                }
            } else {
                showFeedback(false, `ä¸æ­£è§£... æ­£è§£ã¯ã€Œ${correct}ã€ã§ã—ãŸ`);
                // æ­£è§£ã‚’è¡¨ç¤º
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    if (btn.textContent.trim() === correct) {
                        btn.classList.add('correct');
                    }
                });
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 2000);
        }

        // éŸ³å£°èªè­˜é–‹å§‹
        let isRecording = false;
        async function startRecording() {
            // ã¾ãšãƒã‚¤ã‚¯ã®è¨±å¯ã‚’ç¢ºèª
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ');
            } catch (error) {
                console.error('ãƒã‚¤ã‚¯è¨±å¯ã‚¨ãƒ©ãƒ¼:', error);
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                    const isEdge = /Edg/.test(navigator.userAgent);
                    
                    let instructions = '';
                    if (isChrome) {
                        instructions = 'ã€Chromeã§ã®è¨­å®šæ–¹æ³•ã€‘\n' +
                            '1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®å³å´ã«ã‚ã‚‹ğŸ”’ã¾ãŸã¯ğŸ“·ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
                            '2. ã€Œãƒã‚¤ã‚¯ã€ã®è¨­å®šã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n' +
                            '3. ã€Œå®Œäº†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿';
                    } else if (isEdge) {
                        instructions = 'ã€Edgeã§ã®è¨­å®šæ–¹æ³•ã€‘\n' +
                            '1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®å·¦å´ã«ã‚ã‚‹ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
                            '2. ã€Œãƒã‚¤ã‚¯ã€ã®æ¨©é™ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n' +
                            '3. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆF5ã‚­ãƒ¼ï¼‰';
                    } else {
                        instructions = 'ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®è¨­å®šæ–¹æ³•ã€‘\n' +
                            '1. URLãƒãƒ¼ã®ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
                            '2. ã‚µã‚¤ãƒˆã®è¨­å®šã¾ãŸã¯æ¨©é™è¨­å®šã‚’é–‹ã\n' +
                            '3. ã€Œãƒã‚¤ã‚¯ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n' +
                            '4. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿';
                    }
                    
                    alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\n\n' + instructions);
                } else if (error.name === 'NotFoundError') {
                    alert('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n\nã€ç¢ºèªäº‹é …ã€‘\nãƒ»ãƒã‚¤ã‚¯ãŒæ­£ã—ãæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹\nãƒ»ä»–ã®ã‚¢ãƒ—ãƒªãŒãƒã‚¤ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹\nãƒ»ãƒ‡ãƒã‚¤ã‚¹ã®éŸ³å£°è¨­å®šã§ãƒã‚¤ã‚¯ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹');
                } else {
                    alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error.message);
                }
                return;
            }
            
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nChrome ã¾ãŸã¯ Edge ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
                    return;
                }
            }
            
            const recordBtn = document.getElementById('recordBtn');
            const recognizedDiv = document.getElementById('recognizedText');
            
            if (!isRecording) {
                isRecording = true;
                recordBtn.classList.add('listening');
                recordBtn.textContent = 'â¹ï¸ éŒ²éŸ³åœæ­¢';
                recognizedDiv.innerHTML = '<p style="color: #666;">èãå–ã‚Šä¸­...</p>';
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                recognition.onresult = null;
                recognition.onerror = null;
                recognition.onend = null;
                
                recognition.onresult = function(event) {
                    console.log('éŸ³å£°èªè­˜çµæœ:', event);
                    const transcript = event.results[0][0].transcript;
                    console.log('èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ:', transcript);
                    checkSpeaking(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event);
                    isRecording = false;
                    recordBtn.classList.remove('listening');
                    recordBtn.textContent = 'ğŸ¤ éŒ²éŸ³é–‹å§‹';
                    
                    let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    if (event.error === 'not-allowed') {
                        errorMessage = `
                            <strong>ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“</strong><br><br>
                            ã€è§£æ±ºæ–¹æ³•ã€‘<br>
                            1. URLãƒãƒ¼ã®ğŸ”’ã¾ãŸã¯ğŸ“·ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
                            2. ã€Œãƒã‚¤ã‚¯ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´<br>
                            3. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆF5ã‚­ãƒ¼ï¼‰<br><br>
                            <button class="hint-btn" onclick="location.reload()" style="margin-top: 10px;">
                                ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                            </button>
                        `;
                    } else if (event.error === 'no-speech') {
                        errorMessage = 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                    } else if (event.error === 'network') {
                        errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    }
                    recognizedDiv.innerHTML = `<p style="color: #f44336;">${errorMessage}</p>`;
                };
                
                recognition.onend = function() {
                    console.log('éŸ³å£°èªè­˜çµ‚äº†');
                    isRecording = false;
                    recordBtn.classList.remove('listening');
                    recordBtn.textContent = 'ğŸ¤ éŒ²éŸ³é–‹å§‹';
                };
                
                try {
                    recognition.start();
                    console.log('éŸ³å£°èªè­˜é–‹å§‹');
                } catch (error) {
                    console.error('éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    isRecording = false;
                    recordBtn.classList.remove('listening');
                    recordBtn.textContent = 'ğŸ¤ éŒ²éŸ³é–‹å§‹';
                    alert('éŸ³å£°èªè­˜ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } else {
                recognition.stop();
                isRecording = false;
                recordBtn.classList.remove('listening');
                recordBtn.textContent = 'ğŸ¤ éŒ²éŸ³é–‹å§‹';
            }
        }

        // ç™ºéŸ³ãƒã‚§ãƒƒã‚¯
        function checkSpeaking(transcript) {
            const recognizedDiv = document.getElementById('recognizedText');
            const similarity = calculateSimilarity(currentQuestion.english.toLowerCase(), transcript.toLowerCase());
            
            isRecording = false;
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.classList.remove('listening');
            recordBtn.textContent = 'ğŸ¤ éŒ²éŸ³é–‹å§‹';
            
            recognizedDiv.innerHTML = `
                <p>èªè­˜çµæœ: <strong>"${transcript}"</strong></p>
                <p>æ­£è§£: <strong>"${currentQuestion.english}"</strong></p>
            `;
            
            if (similarity > 0.8) {
                score++;
                showFeedback(true, `ç´ æ™´ã‚‰ã—ã„ç™ºéŸ³ã§ã™ï¼ğŸ‰ (${Math.round(similarity * 100)}%)`);
            } else if (similarity > 0.6) {
                score += 0.5;
                showFeedback(true, `è‰¯ã„ç™ºéŸ³ã§ã™ï¼ğŸ˜Š (${Math.round(similarity * 100)}%)`);
            } else {
                showFeedback(false, `ã‚‚ã†å°‘ã—ç·´ç¿’ã—ã¾ã—ã‚‡ã† ğŸ’ª (${Math.round(similarity * 100)}%)`);
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 3000);
        }

        // ãƒ‡ã‚£ã‚¯ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        function checkDictation() {
            const input = document.getElementById('dictationInput').value.trim();
            const correct = currentQuestion.english;
            const similarity = calculateSimilarity(correct.toLowerCase(), input.toLowerCase());
            
            if (similarity > 0.9) {
                score++;
                showFeedback(true, 'å®Œç’§ã§ã™ï¼ğŸ‰');
                // æ­£è§£ã®éŸ³å£°ã‚’å†ç”Ÿ
                if (isSpeechAvailable) {
                    setTimeout(() => {
                        try {
                            const utterance = new SpeechSynthesisUtterance(correct);
                            utterance.lang = 'en-US';
                            utterance.rate = 0.9;
                            window.speechSynthesis.speak(utterance);
                        } catch (error) {
                            console.error('æ­£è§£éŸ³å£°ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    }, 500);
                }
            } else if (similarity > 0.7) {
                showFeedback(true, `ã»ã¼æ­£è§£ï¼ğŸ˜Š æ­£è§£: "${correct}"`);
            } else {
                showFeedback(false, `ä¸æ­£è§£... æ­£è§£ã¯ã€Œ${correct}ã€ã§ã—ãŸ`);
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 2500);
        }

        // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
        function showHint() {
            const hintDiv = document.getElementById('hintText');
            const words = currentQuestion.english.split(' ');
            const hint = words.map(word => word[0] + '_'.repeat(word.length - 1)).join(' ');
            hintDiv.innerHTML = `<p class="hint-text">ãƒ’ãƒ³ãƒˆ: ${hint}</p>`;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        function showFeedback(isCorrect, message) {
            const content = document.getElementById('quizContent');
            const feedback = document.createElement('div');
            feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedback.textContent = message;
            content.appendChild(feedback);
            
            // æ­£è§£éŸ³/ä¸æ­£è§£éŸ³ã‚’å†ç”Ÿ
            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(isCorrect ? 'Good job!' : 'Try again');
                utterance.lang = 'en-US';
                utterance.rate = 1.2;
                utterance.volume = 0.5;
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯éŸ³å£°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // é¡ä¼¼åº¦è¨ˆç®—
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢
        function levenshteinDistance(str1, str2) {
            const m = str1.length;
            const n = str2.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
            
            for (let i = 0; i <= m; i++) dp[i][0] = i;
            for (let j = 0; j <= n; j++) dp[0][j] = j;
            
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (str1[i - 1] === str2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1];
                    } else {
                        dp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
                    }
                }
            }
            
            return dp[m][n];
        }

        // çµæœè¡¨ç¤º
        function showResults() {
            const percentage = Math.round((score / questions.length) * 100);
            let message = '';
            let emoji = '';
            
            if (percentage >= 90) {
                message = 'ç´ æ™´ã‚‰ã—ã„ï¼ãƒã‚¹ã‚¿ãƒ¼ãƒ¬ãƒ™ãƒ«ã§ã™ï¼';
                emoji = 'ğŸ†';
            } else if (percentage >= 70) {
                message = 'ã¨ã¦ã‚‚è‰¯ãã§ãã¾ã—ãŸï¼';
                emoji = 'ğŸŒŸ';
            } else if (percentage >= 50) {
                message = 'ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸï¼';
                emoji = 'ğŸ‘';
            } else {
                message = 'ã‚‚ã†å°‘ã—ç·´ç¿’ã—ã¾ã—ã‚‡ã†ï¼';
                emoji = 'ğŸ’ª';
            }
            
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="results-container">
                    <h2 class="results-title">ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼ ${emoji}</h2>
                    <div class="results-score">${score} / ${questions.length}</div>
                    <div class="results-message">${message}</div>
                    <div class="results-details">
                        <p>æ­£ç­”ç‡: ${percentage}%</p>
                        <p>ãƒ¢ãƒ¼ãƒ‰: ${getCurrentModeName()}</p>
                    </div>
                    <button class="restart-btn" onclick="location.reload()">
                        ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹ ğŸ”„
                    </button>
                </div>
            `;
            
            // çµæœéŸ³å£°
            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(`Great job! You scored ${score} out of ${questions.length}.`);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('çµæœéŸ³å£°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰åå–å¾—
        function getCurrentModeName() {
            const names = {
                translate: 'ç¿»è¨³ã‚¯ã‚¤ã‚º',
                listening: 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚¯ã‚¤ã‚º',
                speaking: 'ç™ºéŸ³ã‚¯ã‚¤ã‚º',
                dictation: 'ãƒ‡ã‚£ã‚¯ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³'
            };
            return names[currentMode];
        }

        // éŸ³å£°ãƒ†ã‚¹ãƒˆ
        function testVoice() {
            if (!isSpeechAvailable) {
                alert('éŸ³å£°æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance('Hello! Voice test successful.');
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                
                utterance.onend = function() {
                    alert('éŸ³å£°ãƒ†ã‚¹ãƒˆæˆåŠŸï¼éŸ³å£°æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚');
                };
                
                utterance.onerror = function(event) {
                    alert('éŸ³å£°ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + event.error);
                };
                
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                alert('éŸ³å£°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆ
        async function testMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                stream.getTracks().forEach(track => track.stop());
                
                alert('ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸï¼âœ…\n\nãƒã‚¤ã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚\nç™ºéŸ³ã‚¯ã‚¤ã‚ºã§éŸ³å£°èªè­˜ãŒä½¿ç”¨ã§ãã¾ã™ã€‚');
            } catch (error) {
                console.error('ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                
                const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                const isEdge = /Edg/.test(navigator.userAgent);
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    let message = 'ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\n\n';
                    
                    if (isChrome) {
                        message += 'ã€Chromeã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã™ã‚‹æ–¹æ³•ã€‘\n\n' +
                            'æ–¹æ³•1ï¼ˆæ¨å¥¨ï¼‰:\n' +
                            '1. ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹\n' +
                            '2. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å³å´ã®ğŸ“·ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
                            '3. ã€Œãƒã‚¤ã‚¯ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n' +
                            '4. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆF5ã‚­ãƒ¼ï¼‰\n\n' +
                            'æ–¹æ³•2:\n' +
                            '1. Chromeè¨­å®š â†’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£\n' +
                            '2. ã‚µã‚¤ãƒˆã®è¨­å®š â†’ ãƒã‚¤ã‚¯\n' +
                            '3. ã“ã®ã‚µã‚¤ãƒˆã‚’ã€Œè¨±å¯ã€ã«è¿½åŠ ';
                    } else if (isEdge) {
                        message += 'ã€Edgeã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã™ã‚‹æ–¹æ³•ã€‘\n\n' +
                            '1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦å´ã®ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
                            '2. ã€Œã“ã®ã‚µã‚¤ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã€ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
                            '3. ã€Œãƒã‚¤ã‚¯ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n' +
                            '4. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆF5ã‚­ãƒ¼ï¼‰';
                    } else {
                        message += 'ã€ãƒã‚¤ã‚¯ã‚’è¨±å¯ã™ã‚‹æ–¹æ³•ã€‘\n\n' +
                            '1. ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’é–‹ã\n' +
                            '2. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š\n' +
                            '3. ã‚µã‚¤ãƒˆã®æ¨©é™ â†’ ãƒã‚¤ã‚¯\n' +
                            '4. ã“ã®ã‚µã‚¤ãƒˆã‚’è¨±å¯ãƒªã‚¹ãƒˆã«è¿½åŠ \n' +
                            '5. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿';
                    }
                    
                    alert(message);
                } else if (error.name === 'NotFoundError') {
                    alert('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚âŒ\n\nã€ç¢ºèªã—ã¦ãã ã•ã„ã€‘\nãƒ»ãƒã‚¤ã‚¯ãŒæ­£ã—ãæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹\nãƒ»ãƒ‡ãƒã‚¤ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ãƒã‚¤ã‚¯ãŒèªè­˜ã•ã‚Œã¦ã„ã‚‹ã‹\nãƒ»ä»–ã®ã‚¢ãƒ—ãƒªï¼ˆZoomç­‰ï¼‰ãŒãƒã‚¤ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹\nãƒ»Windowsã®ã€Œè¨­å®šã€â†’ã€Œãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã€â†’ã€Œãƒã‚¤ã‚¯ã€ã§\n  ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹');
                } else {
                    alert('ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\nåˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChrome/Edgeï¼‰ã§ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            }
        }
    </script>
</body>
</html>
