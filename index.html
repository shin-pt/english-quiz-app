<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英会話クイズ - 旅行フレーズマスター</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .quiz-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }

        .quiz-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: #e0e0e0;
        }

        .quiz-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }

        .quiz-counter {
            font-size: 1.2em;
            color: #666;
        }

        .quiz-score {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
        }

        .quiz-content {
            text-align: center;
            padding: 20px 0;
        }

        .question-text {
            font-size: 2em;
            color: #333;
            margin-bottom: 40px;
            line-height: 1.4;
            font-weight: 600;
        }

        .answer-options {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .answer-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 15px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .answer-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(5px);
        }

        .answer-btn.correct {
            background: #e8f5e9;
            border-color: #4caf50;
            animation: correctPulse 0.6s ease;
        }

        .answer-btn.incorrect {
            background: #ffebee;
            border-color: #f44336;
            animation: shake 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .voice-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 50px;
            background: #667eea;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .voice-btn:active {
            transform: translateY(0);
        }

        .voice-btn.listening {
            background: #f44336;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        .input-container {
            margin-bottom: 30px;
        }

        .text-input {
            width: 100%;
            padding: 20px;
            font-size: 1.3em;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .submit-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            background: #4caf50;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .feedback {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1em;
            animation: slideIn 0.5s ease;
        }

        .feedback.correct {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .feedback.incorrect {
            background: #ffebee;
            color: #c62828;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .results-title {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 30px;
        }

        .results-score {
            font-size: 4em;
            color: #4caf50;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .results-message {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 30px;
        }

        .results-details {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .restart-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            background: #667eea;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .start-screen {
            text-align: center;
            padding: 40px;
        }

        .start-screen h2 {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
        }

        .start-screen p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .start-btn {
            padding: 20px 50px;
            border: none;
            border-radius: 50px;
            background: #4caf50;
            color: white;
            font-size: 1.4em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
        }

        .hint-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: #ff9800;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .hint-btn:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .hint-text {
            color: #ff9800;
            font-style: italic;
            margin-top: 15px;
            font-size: 1.1em;
        }

        .permission-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .permission-info h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .permission-info ol {
            margin-left: 20px;
            color: #856404;
        }

        .permission-info li {
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .mode-btn {
                font-size: 1em;
                padding: 12px 20px;
            }
            
            .question-text {
                font-size: 1.5em;
            }
            
            .quiz-container {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 英会話クイズ</h1>
            <p>旅行で使える英会話フレーズをクイズで楽しく学習！</p>
            <div class="mode-selector" id="modeSelector">
                <button class="mode-btn active" onclick="selectMode('translate')">
                    📝 翻訳クイズ
                </button>
                <button class="mode-btn" onclick="selectMode('listening')">
                    🎧 リスニングクイズ
                </button>
                <button class="mode-btn" onclick="selectMode('speaking')">
                    🎤 発音クイズ
                </button>
                <button class="mode-btn" onclick="selectMode('dictation')">
                    ✍️ ディクテーション
                </button>
            </div>
        </div>

        <div class="quiz-container" id="quizContainer">
            <div class="start-screen" id="startScreen">
                <h2>📝 翻訳クイズ</h2>
                <p>
                    日本語のフレーズを見て、正しい英訳を選んでください。<br>
                    全20問のクイズに挑戦しましょう！
                </p>
                <button class="start-btn" onclick="startQuiz()">
                    クイズを開始 🚀
                </button>
                <br><br>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="voice-btn" onclick="testVoice()" style="font-size: 0.9em; padding: 10px 20px;">
                        🔊 音声テスト
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // フレーズデータ
        const phrases = [
            { id: 1, japanese: "こんにちは", english: "Hello", category: "greeting", difficulty: 1 },
            { id: 2, japanese: "ありがとうございます", english: "Thank you", category: "greeting", difficulty: 1 },
            { id: 3, japanese: "すみません", english: "Excuse me", category: "greeting", difficulty: 1 },
            { id: 4, japanese: "これはいくらですか？", english: "How much is this?", category: "shopping", difficulty: 1 },
            { id: 5, japanese: "クレジットカードは使えますか？", english: "Do you accept credit cards?", category: "shopping", difficulty: 2 },
            { id: 6, japanese: "トイレはどこですか？", english: "Where is the restroom?", category: "direction", difficulty: 1 },
            { id: 7, japanese: "道に迷いました", english: "I'm lost", category: "direction", difficulty: 2 },
            { id: 8, japanese: "英語を話せますか？", english: "Do you speak English?", category: "communication", difficulty: 1 },
            { id: 9, japanese: "もう一度言ってください", english: "Please say that again", category: "communication", difficulty: 2 },
            { id: 10, japanese: "チェックインをお願いします", english: "I'd like to check in", category: "hotel", difficulty: 2 },
            { id: 11, japanese: "予約があります", english: "I have a reservation", category: "hotel", difficulty: 2 },
            { id: 12, japanese: "メニューをください", english: "May I have the menu?", category: "restaurant", difficulty: 1 },
            { id: 13, japanese: "お勧めは何ですか？", english: "What do you recommend?", category: "restaurant", difficulty: 2 },
            { id: 14, japanese: "お会計をお願いします", english: "Check please", category: "restaurant", difficulty: 1 },
            { id: 15, japanese: "アレルギーがあります", english: "I have allergies", category: "restaurant", difficulty: 3 },
            { id: 16, japanese: "タクシーを呼んでください", english: "Please call a taxi", category: "transportation", difficulty: 2 },
            { id: 17, japanese: "空港までお願いします", english: "To the airport please", category: "transportation", difficulty: 2 },
            { id: 18, japanese: "いつ到着しますか？", english: "When will we arrive?", category: "transportation", difficulty: 2 },
            { id: 19, japanese: "助けてください", english: "Help me please", category: "emergency", difficulty: 1 },
            { id: 20, japanese: "医者を呼んでください", english: "Please call a doctor", category: "emergency", difficulty: 3 }
        ];

        // ゲーム状態
        let currentMode = 'translate';
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = [];
        let currentQuestion = null;
        let isAnswering = false;
        let recognition = null;
        let isSpeechAvailable = false;

        // 初期化処理
        window.addEventListener('DOMContentLoaded', function() {
            // 音声合成APIのチェック
            if ('speechSynthesis' in window) {
                isSpeechAvailable = true;
                console.log('音声合成API利用可能');
                
                // 音声リストの読み込みを待つ
                if (speechSynthesis.getVoices().length === 0) {
                    speechSynthesis.addEventListener('voiceschanged', function() {
                        console.log('音声リスト読み込み完了');
                    });
                }
            } else {
                console.error('音声合成APIが利用できません');
                alert('お使いのブラウザは音声機能に対応していません。\nChrome、Edge、Safari等の最新ブラウザをご利用ください。');
            }
        });

        // 音声認識の初期化
        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.error('音声認識がサポートされていません');
                    return false;
                }
                
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                console.log('音声認識を初期化しました');
                return true;
            } catch (error) {
                console.error('音声認識の初期化エラー:', error);
                return false;
            }
        }

        // モード選択
        function selectMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // スタート画面を更新
            const startScreen = document.getElementById('startScreen');
            const modeInfo = {
                translate: {
                    title: '📝 翻訳クイズ',
                    desc: '日本語のフレーズを見て、正しい英訳を選んでください。'
                },
                listening: {
                    title: '🎧 リスニングクイズ',
                    desc: '英語の音声を聞いて、正しい日本語訳を選んでください。'
                },
                speaking: {
                    title: '🎤 発音クイズ',
                    desc: '日本語を見て、英語で発音してください。'
                },
                dictation: {
                    title: '✍️ ディクテーション',
                    desc: '英語の音声を聞いて、正しく書き取ってください。'
                }
            };
            
            startScreen.innerHTML = `
                <h2>${modeInfo[mode].title}</h2>
                <p>${modeInfo[mode].desc}<br>全20問のクイズに挑戦しましょう！</p>
                <button class="start-btn" onclick="startQuiz()">
                    クイズを開始 🚀
                </button>
                <br><br>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="voice-btn" onclick="testVoice()" style="font-size: 0.9em; padding: 10px 20px;">
                        🔊 音声テスト
                    </button>
                    ${mode === 'speaking' ? `
                        <button class="voice-btn" onclick="testMicrophone()" style="font-size: 0.9em; padding: 10px 20px; background: #ff9800;">
                            🎤 マイクテスト
                        </button>
                    ` : ''}
                </div>
                ${mode === 'speaking' ? `
                    <p style="color: #666; font-size: 0.9em; margin-top: 20px;">
                        ※ 発音クイズを始める前に、マイクテストで動作確認をお勧めします
                    </p>
                ` : ''}
            `;
        }

        // クイズ開始
        async function startQuiz() {
            // 発音クイズの場合、事前にマイク許可を確認
            if (currentMode === 'speaking') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    console.log('マイク許可確認済み');
                } catch (error) {
                    console.error('マイク許可エラー:', error);
                    
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        const confirmStart = confirm(
                            '⚠️ マイクの使用が拒否されています\n\n' +
                            '発音クイズではマイクが必要です。\n' +
                            '以下の手順で許可してください：\n\n' +
                            '1. このダイアログを閉じる\n' +
                            '2. アドレスバーの🔒または📷アイコンをクリック\n' +
                            '3. 「マイク」を「許可」に変更\n' +
                            '4. ページを再読み込み\n\n' +
                            'マイクなしで続けますか？（録音機能は使用できません）'
                        );
                        if (!confirmStart) {
                            return;
                        }
                    } else {
                        const confirmStart = confirm(
                            '⚠️ マイクにアクセスできません\n\n' +
                            'エラー: ' + error.message + '\n\n' +
                            'マイクなしで続けますか？（録音機能は使用できません）'
                        );
                        if (!confirmStart) {
                            return;
                        }
                    }
                }
            }
            
            currentQuestionIndex = 0;
            score = 0;
            questions = [...phrases].sort(() => Math.random() - 0.5);
            initSpeechRecognition();
            showQuestion();
        }

        // 質問表示
        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }
            
            currentQuestion = questions[currentQuestionIndex];
            isAnswering = false;
            
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="quiz-progress">
                    <div class="quiz-progress-bar" style="width: ${(currentQuestionIndex / questions.length) * 100}%"></div>
                </div>
                <div class="quiz-header">
                    <div class="quiz-counter">問題 ${currentQuestionIndex + 1} / ${questions.length}</div>
                    <div class="quiz-score">スコア: ${score}</div>
                </div>
                <div class="quiz-content" id="quizContent">
                    ${getQuestionContent()}
                </div>
            `;
            
            // モードごとの初期処理
            if (currentMode === 'listening') {
                // 少し遅延を入れて音声を再生（UIの描画を待つ）
                setTimeout(() => {
                    console.log('リスニングクイズ: 音声を自動再生');
                    playQuestionAudio();
                }, 1000);
            }
        }

        // 質問コンテンツ生成
        function getQuestionContent() {
            switch (currentMode) {
                case 'translate':
                    return `
                        <div class="question-text">${currentQuestion.japanese}</div>
                        <div class="answer-options">
                            ${generateMultipleChoice('english').map((option, index) => `
                                <button class="answer-btn" onclick="checkAnswer('${option}', this)">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    `;
                
                case 'listening':
                    return `
                        <div class="voice-controls">
                            <button class="voice-btn" onclick="playQuestionAudio()">
                                🔊 もう一度聞く
                            </button>
                        </div>
                        <div class="question-text">どういう意味でしょうか？</div>
                        <div class="answer-options">
                            ${generateMultipleChoice('japanese').map((option, index) => `
                                <button class="answer-btn" onclick="checkAnswer('${option}', this)">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    `;
                
                case 'speaking':
                    return `
                        <div class="question-text">${currentQuestion.japanese}</div>
                        <p style="color: #666; margin-bottom: 20px;">英語で発音してください</p>
                        <div class="voice-controls">
                            <button class="voice-btn" id="recordBtn" onclick="startRecording()">
                                🎤 録音開始
                            </button>
                            <button class="voice-btn" onclick="playAnswer()">
                                🔊 お手本を聞く
                            </button>
                        </div>
                        <div id="recognizedText" style="margin-top: 20px;"></div>
                        <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                            💡 ヒント: 初回はブラウザがマイク使用許可を求めます。「許可」をクリックしてください。
                        </div>
                    `;
                
                case 'dictation':
                    return `
                        <div class="voice-controls">
                            <button class="voice-btn" onclick="playQuestionAudio()">
                                🔊 もう一度聞く
                            </button>
                        </div>
                        <div class="question-text">聞こえた英語を入力してください</div>
                        <div class="input-container">
                            <input type="text" class="text-input" id="dictationInput" 
                                   placeholder="英語を入力..." onkeypress="if(event.key==='Enter') checkDictation()">
                        </div>
                        <button class="submit-btn" onclick="checkDictation()">回答する</button>
                        <button class="hint-btn" onclick="showHint()">ヒントを見る</button>
                        <div id="hintText"></div>
                    `;
            }
        }

        // 選択肢生成
        function generateMultipleChoice(type) {
            const correct = currentQuestion[type];
            const options = [correct];
            
            // 他の選択肢を追加
            const others = phrases
                .filter(p => p.id !== currentQuestion.id)
                .map(p => p[type])
                .sort(() => Math.random() - 0.5)
                .slice(0, 3);
            
            options.push(...others);
            return options.sort(() => Math.random() - 0.5);
        }

        // 音声再生
        function playQuestionAudio() {
            if (!isSpeechAvailable) {
                alert('音声機能が利用できません');
                return;
            }
            
            try {
                // 既存の音声を停止
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(currentQuestion.english);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // エラーハンドリング
                utterance.onerror = function(event) {
                    console.error('音声再生エラー:', event);
                    alert('音声再生でエラーが発生しました');
                };
                
                // 再生
                window.speechSynthesis.speak(utterance);
                console.log('音声再生:', currentQuestion.english);
            } catch (error) {
                console.error('音声再生エラー:', error);
                alert('音声機能が利用できません');
            }
        }

        function playAnswer() {
            if (!isSpeechAvailable) {
                alert('音声機能が利用できません');
                return;
            }
            
            try {
                // 既存の音声を停止
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(currentQuestion.english);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                utterance.onerror = function(event) {
                    console.error('音声再生エラー:', event);
                };
                
                window.speechSynthesis.speak(utterance);
                console.log('お手本音声再生:', currentQuestion.english);
            } catch (error) {
                console.error('音声再生エラー:', error);
                alert('音声機能が利用できません');
            }
        }

        // 回答チェック（選択式）
        function checkAnswer(answer, button) {
            if (isAnswering) return;
            isAnswering = true;
            
            const correct = currentMode === 'listening' ? currentQuestion.japanese : currentQuestion.english;
            const isCorrect = answer === correct;
            
            button.classList.add(isCorrect ? 'correct' : 'incorrect');
            
            if (isCorrect) {
                score++;
                showFeedback(true, '正解！🎉');
                // 正解の場合、英語フレーズを読み上げる
                if (isSpeechAvailable && currentMode === 'translate') {
                    setTimeout(() => {
                        try {
                            const utterance = new SpeechSynthesisUtterance(currentQuestion.english);
                            utterance.lang = 'en-US';
                            utterance.rate = 0.9;
                            window.speechSynthesis.speak(utterance);
                        } catch (error) {
                            console.error('正解音声エラー:', error);
                        }
                    }, 500);
                }
            } else {
                showFeedback(false, `不正解... 正解は「${correct}」でした`);
                // 正解を表示
                document.querySelectorAll('.answer-btn').forEach(btn => {
                    if (btn.textContent.trim() === correct) {
                        btn.classList.add('correct');
                    }
                });
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 2000);
        }

        // 音声認識開始
        let isRecording = false;
        async function startRecording() {
            // まずマイクの許可を確認
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('マイクの使用が許可されました');
            } catch (error) {
                console.error('マイク許可エラー:', error);
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                    const isEdge = /Edg/.test(navigator.userAgent);
                    
                    let instructions = '';
                    if (isChrome) {
                        instructions = '【Chromeでの設定方法】\n' +
                            '1. アドレスバーの右側にある🔒または📷アイコンをクリック\n' +
                            '2. 「マイク」の設定を「許可」に変更\n' +
                            '3. 「完了」をクリックしてページを再読み込み';
                    } else if (isEdge) {
                        instructions = '【Edgeでの設定方法】\n' +
                            '1. アドレスバーの左側にある🔒アイコンをクリック\n' +
                            '2. 「マイク」の権限を「許可」に変更\n' +
                            '3. ページを再読み込み（F5キー）';
                    } else {
                        instructions = '【ブラウザでの設定方法】\n' +
                            '1. URLバーの🔒アイコンをクリック\n' +
                            '2. サイトの設定または権限設定を開く\n' +
                            '3. 「マイク」を「許可」に変更\n' +
                            '4. ページを再読み込み';
                    }
                    
                    alert('マイクの使用が拒否されました。\n\n' + instructions);
                } else if (error.name === 'NotFoundError') {
                    alert('マイクが見つかりません。\n\n【確認事項】\n・マイクが正しく接続されているか\n・他のアプリがマイクを使用していないか\n・デバイスの音声設定でマイクが有効になっているか');
                } else {
                    alert('マイクへのアクセスでエラーが発生しました。\n\nエラー詳細: ' + error.message);
                }
                return;
            }
            
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    alert('お使いのブラウザは音声認識に対応していません。\nChrome または Edge をご利用ください。');
                    return;
                }
            }
            
            const recordBtn = document.getElementById('recordBtn');
            const recognizedDiv = document.getElementById('recognizedText');
            
            if (!isRecording) {
                isRecording = true;
                recordBtn.classList.add('listening');
                recordBtn.textContent = '⏹️ 録音停止';
                recognizedDiv.innerHTML = '<p style="color: #666;">聞き取り中...</p>';
                
                // イベントハンドラーをクリア
                recognition.onresult = null;
                recognition.onerror = null;
                recognition.onend = null;
                
                recognition.onresult = function(event) {
                    console.log('音声認識結果:', event);
                    const transcript = event.results[0][0].transcript;
                    console.log('認識されたテキスト:', transcript);
                    checkSpeaking(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('音声認識エラー:', event);
                    isRecording = false;
                    recordBtn.classList.remove('listening');
                    recordBtn.textContent = '🎤 録音開始';
                    
                    let errorMessage = 'エラーが発生しました';
                    if (event.error === 'not-allowed') {
                        errorMessage = `
                            <strong>マイクの使用が許可されていません</strong><br><br>
                            【解決方法】<br>
                            1. URLバーの🔒または📷アイコンをクリック<br>
                            2. 「マイク」を「許可」に変更<br>
                            3. ページを再読み込み（F5キー）<br><br>
                            <button class="hint-btn" onclick="location.reload()" style="margin-top: 10px;">
                                ページを再読み込み
                            </button>
                        `;
                    } else if (event.error === 'no-speech') {
                        errorMessage = '音声が検出されませんでした。もう一度お試しください。';
                    } else if (event.error === 'network') {
                        errorMessage = 'ネットワークエラーが発生しました。';
                    }
                    recognizedDiv.innerHTML = `<p style="color: #f44336;">${errorMessage}</p>`;
                };
                
                recognition.onend = function() {
                    console.log('音声認識終了');
                    isRecording = false;
                    recordBtn.classList.remove('listening');
                    recordBtn.textContent = '🎤 録音開始';
                };
                
                try {
                    recognition.start();
                    console.log('音声認識開始');
                } catch (error) {
                    console.error('音声認識開始エラー:', error);
                    isRecording = false;
                    recordBtn.classList.remove('listening');
                    recordBtn.textContent = '🎤 録音開始';
                    alert('音声認識を開始できませんでした。');
                }
            } else {
                recognition.stop();
                isRecording = false;
                recordBtn.classList.remove('listening');
                recordBtn.textContent = '🎤 録音開始';
            }
        }

        // 発音チェック
        function checkSpeaking(transcript) {
            const recognizedDiv = document.getElementById('recognizedText');
            const similarity = calculateSimilarity(currentQuestion.english.toLowerCase(), transcript.toLowerCase());
            
            isRecording = false;
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.classList.remove('listening');
            recordBtn.textContent = '🎤 録音開始';
            
            recognizedDiv.innerHTML = `
                <p>認識結果: <strong>"${transcript}"</strong></p>
                <p>正解: <strong>"${currentQuestion.english}"</strong></p>
            `;
            
            if (similarity > 0.8) {
                score++;
                showFeedback(true, `素晴らしい発音です！🎉 (${Math.round(similarity * 100)}%)`);
            } else if (similarity > 0.6) {
                score += 0.5;
                showFeedback(true, `良い発音です！😊 (${Math.round(similarity * 100)}%)`);
            } else {
                showFeedback(false, `もう少し練習しましょう 💪 (${Math.round(similarity * 100)}%)`);
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 3000);
        }

        // ディクテーションチェック
        function checkDictation() {
            const input = document.getElementById('dictationInput').value.trim();
            const correct = currentQuestion.english;
            const similarity = calculateSimilarity(correct.toLowerCase(), input.toLowerCase());
            
            if (similarity > 0.9) {
                score++;
                showFeedback(true, '完璧です！🎉');
                // 正解の音声を再生
                if (isSpeechAvailable) {
                    setTimeout(() => {
                        try {
                            const utterance = new SpeechSynthesisUtterance(correct);
                            utterance.lang = 'en-US';
                            utterance.rate = 0.9;
                            window.speechSynthesis.speak(utterance);
                        } catch (error) {
                            console.error('正解音声エラー:', error);
                        }
                    }, 500);
                }
            } else if (similarity > 0.7) {
                showFeedback(true, `ほぼ正解！😊 正解: "${correct}"`);
            } else {
                showFeedback(false, `不正解... 正解は「${correct}」でした`);
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 2500);
        }

        // ヒント表示
        function showHint() {
            const hintDiv = document.getElementById('hintText');
            const words = currentQuestion.english.split(' ');
            const hint = words.map(word => word[0] + '_'.repeat(word.length - 1)).join(' ');
            hintDiv.innerHTML = `<p class="hint-text">ヒント: ${hint}</p>`;
        }

        // フィードバック表示
        function showFeedback(isCorrect, message) {
            const content = document.getElementById('quizContent');
            const feedback = document.createElement('div');
            feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedback.textContent = message;
            content.appendChild(feedback);
            
            // 正解音/不正解音を再生
            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(isCorrect ? 'Good job!' : 'Try again');
                utterance.lang = 'en-US';
                utterance.rate = 1.2;
                utterance.volume = 0.5;
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('フィードバック音声エラー:', error);
            }
        }

        // 類似度計算
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // レーベンシュタイン距離
        function levenshteinDistance(str1, str2) {
            const m = str1.length;
            const n = str2.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
            
            for (let i = 0; i <= m; i++) dp[i][0] = i;
            for (let j = 0; j <= n; j++) dp[0][j] = j;
            
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (str1[i - 1] === str2[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1];
                    } else {
                        dp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
                    }
                }
            }
            
            return dp[m][n];
        }

        // 結果表示
        function showResults() {
            const percentage = Math.round((score / questions.length) * 100);
            let message = '';
            let emoji = '';
            
            if (percentage >= 90) {
                message = '素晴らしい！マスターレベルです！';
                emoji = '🏆';
            } else if (percentage >= 70) {
                message = 'とても良くできました！';
                emoji = '🌟';
            } else if (percentage >= 50) {
                message = 'よく頑張りました！';
                emoji = '👍';
            } else {
                message = 'もう少し練習しましょう！';
                emoji = '💪';
            }
            
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="results-container">
                    <h2 class="results-title">クイズ終了！ ${emoji}</h2>
                    <div class="results-score">${score} / ${questions.length}</div>
                    <div class="results-message">${message}</div>
                    <div class="results-details">
                        <p>正答率: ${percentage}%</p>
                        <p>モード: ${getCurrentModeName()}</p>
                    </div>
                    <button class="restart-btn" onclick="location.reload()">
                        もう一度挑戦する 🔄
                    </button>
                </div>
            `;
            
            // 結果音声
            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(`Great job! You scored ${score} out of ${questions.length}.`);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('結果音声エラー:', error);
            }
        }

        // 現在のモード名取得
        function getCurrentModeName() {
            const names = {
                translate: '翻訳クイズ',
                listening: 'リスニングクイズ',
                speaking: '発音クイズ',
                dictation: 'ディクテーション'
            };
            return names[currentMode];
        }

        // 音声テスト
        function testVoice() {
            if (!isSpeechAvailable) {
                alert('音声機能が利用できません。\nブラウザを確認してください。');
                return;
            }
            
            try {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance('Hello! Voice test successful.');
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                
                utterance.onend = function() {
                    alert('音声テスト成功！音声機能が正常に動作しています。');
                };
                
                utterance.onerror = function(event) {
                    alert('音声テスト失敗: ' + event.error);
                };
                
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                alert('音声テストエラー: ' + error.message);
            }
        }

        // マイクテスト
        async function testMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // ストリームを停止
                stream.getTracks().forEach(track => track.stop());
                
                alert('マイクテスト成功！✅\n\nマイクが正常に動作しています。\n発音クイズで音声認識が使用できます。');
            } catch (error) {
                console.error('マイクテストエラー:', error);
                
                const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                const isEdge = /Edg/.test(navigator.userAgent);
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    let message = 'マイクの使用が拒否されました。\n\n';
                    
                    if (isChrome) {
                        message += '【Chromeでマイクを許可する方法】\n\n' +
                            '方法1（推奨）:\n' +
                            '1. このメッセージを閉じる\n' +
                            '2. アドレスバー右側の📷アイコンをクリック\n' +
                            '3. 「マイク」を「許可」に変更\n' +
                            '4. ページを再読み込み（F5キー）\n\n' +
                            '方法2:\n' +
                            '1. Chrome設定 → プライバシーとセキュリティ\n' +
                            '2. サイトの設定 → マイク\n' +
                            '3. このサイトを「許可」に追加';
                    } else if (isEdge) {
                        message += '【Edgeでマイクを許可する方法】\n\n' +
                            '1. アドレスバー左側の🔒アイコンをクリック\n' +
                            '2. 「このサイトのアクセス許可」をクリック\n' +
                            '3. 「マイク」を「許可」に変更\n' +
                            '4. ページを再読み込み（F5キー）';
                    } else {
                        message += '【マイクを許可する方法】\n\n' +
                            '1. ブラウザの設定を開く\n' +
                            '2. プライバシー/セキュリティ設定\n' +
                            '3. サイトの権限 → マイク\n' +
                            '4. このサイトを許可リストに追加\n' +
                            '5. ページを再読み込み';
                    }
                    
                    alert(message);
                } else if (error.name === 'NotFoundError') {
                    alert('マイクが見つかりません。❌\n\n【確認してください】\n・マイクが正しく接続されているか\n・デバイスマネージャーでマイクが認識されているか\n・他のアプリ（Zoom等）がマイクを使用していないか\n・Windowsの「設定」→「プライバシー」→「マイク」で\n  ブラウザのマイクアクセスが許可されているか');
                } else {
                    alert('マイクテストでエラーが発生しました。\n\nエラー: ' + error.message + '\n\n別のブラウザ（Chrome/Edge）でお試しください。');
                }
            }
        }
    </script>
</body>
</html>
